{% extends "base.html" %}
{% block title %}âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h1>
    <p class="text-gray-500">Ù…Ø¯ÛŒØ±ÛŒØª Ø§ØªØµØ§Ù„Ø§Øª Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø±Ù†Ø§Ù…Ù‡</p>
</div>

<!-- ÙˆØ¶Ø¹ÛŒØª Ø§ØªØµØ§Ù„Ø§Øª -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <!-- Notion -->
    <div class="card">
        <div class="flex items-center gap-3">
            <span class="text-2xl">ğŸ“</span>
            <div class="flex-1">
                <h3 class="font-medium">Notion API</h3>
                {% if config.notion_configured %}
                <span class="text-green-500 text-sm">âœ… Ù…ØªØµÙ„</span>
                {% else %}
                <span class="text-red-500 text-sm">âŒ ØºÛŒØ±ÙØ¹Ø§Ù„</span>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Google Sheets -->
    <div class="card">
        <div class="flex items-center gap-3">
            <span class="text-2xl">ğŸ“Š</span>
            <div class="flex-1">
                <h3 class="font-medium">Google Sheets</h3>
                {% if config.sheets_configured %}
                <span class="text-green-500 text-sm">âœ… Ù…ØªØµÙ„</span>
                {% else %}
                <span class="text-red-500 text-sm">âŒ ØºÛŒØ±ÙØ¹Ø§Ù„</span>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Telegram -->
    <div class="card">
        <div class="flex items-center gap-3">
            <span class="text-2xl">ğŸ“±</span>
            <div class="flex-1">
                <h3 class="font-medium">Telegram Bot</h3>
                {% if config.telegram_configured %}
                <span class="text-green-500 text-sm">âœ… Ù…ØªØµÙ„</span>
                {% else %}
                <span class="text-gray-400 text-sm">â³ ÙØ§Ø² Ø¨Ø¹Ø¯</span>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- âœ¨ Ø¨Ø®Ø´ Ø¬Ø¯ÛŒØ¯: Sync Notion Structure -->
<div class="card mb-6">
    <div class="flex items-center gap-2 mb-4">
        <span class="text-2xl">ğŸ”„</span>
        <h2 class="card-title">Sync Notion Structure</h2>
    </div>
    
    <p class="text-gray-500 text-sm mb-4">
        Ø¨Ø§ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ <code class="bg-gray-100 px-1 rounded">ADHD_Notion_Structure.md</code>ØŒ 
        Ø¯ÛŒØªØ§Ø¨ÛŒØ³â€ŒÙ‡Ø§ÛŒ TasksØŒ ProjectsØŒ ResourcesØŒ Daily Logs Ùˆ Habits Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø± Notion Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒØ´Ù†.
    </p>
    
    {% if not config.can_sync %}
    <div class="bg-yellow-50 border border-yellow-200 text-yellow-700 px-4 py-3 rounded-xl mb-4">
        âš ï¸ Ø¨Ø±Ø§ÛŒ SyncØŒ Ø¨Ø§ÛŒØ¯ <strong>Parent Page ID</strong> Ø¯Ø± ÙØ§ÛŒÙ„ <code>.env</code> ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ù‡.
        <details class="mt-2">
            <summary class="cursor-pointer text-sm">Ø±Ø§Ù‡Ù†Ù…Ø§</summary>
            <ol class="mt-2 text-sm space-y-1 list-decimal list-inside">
                <li>ÛŒÚ© ØµÙØ­Ù‡ Ø®Ø§Ù„ÛŒ Ø¯Ø± Notion Ø¨Ø³Ø§Ø² (Ù…Ø«Ù„Ø§ "ğŸ§  ADHD System")</li>
                <li>ØµÙØ­Ù‡ Ø±Ùˆ Ø¨Ø§ Integration Ø´ÛŒØ± Ú©Ù† (... â†’ Connections)</li>
                <li>Ù„ÛŒÙ†Ú© ØµÙØ­Ù‡ Ø±Ùˆ Ú©Ù¾ÛŒ Ú©Ù†</li>
                <li>32 Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¢Ø®Ø± (Ù‚Ø¨Ù„ Ø§Ø² ?) Ø±Ùˆ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† NOTION_PARENT_PAGE_ID Ø¨Ø°Ø§Ø±</li>
            </ol>
        </details>
    </div>
    {% else %}
    
    <!-- ÙØ±Ù… Ø¢Ù¾Ù„ÙˆØ¯ -->
    <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl p-6 text-center mb-4" 
         id="drop-zone">
        <input type="file" id="md-file" accept=".md,.txt" class="hidden" onchange="handleFileSelect(this)">
        <div class="text-4xl mb-2">ğŸ“„</div>
        <p class="text-gray-600 mb-2">ÙØ§ÛŒÙ„ MD Ø±Ùˆ Ø¨Ú©Ø´ Ø§ÛŒÙ†Ø¬Ø§ ÛŒØ§ Ú©Ù„ÛŒÚ© Ú©Ù†</p>
        <button onclick="document.getElementById('md-file').click()" 
                class="btn-secondary text-sm">
            Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„
        </button>
        <p class="text-xs text-gray-400 mt-2" id="file-name">ÙØ§ÛŒÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡</p>
    </div>
    
    <!-- ÛŒØ§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø³Ø§Ø®ØªØ§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶ -->
    <div class="text-center mb-4">
        <span class="text-gray-400 text-sm">ÛŒØ§</span>
    </div>
    
    <div class="flex flex-col sm:flex-row gap-2 mb-4">
        <button onclick="syncWithDefault()" class="btn-primary flex-1" id="sync-default-btn">
            ğŸš€ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø³Ø§Ø®ØªØ§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶
        </button>
        <button onclick="syncWithFile()" class="btn-secondary flex-1" id="sync-file-btn" disabled>
            ğŸ“„ Sync Ø¨Ø§ ÙØ§ÛŒÙ„ Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯Ù‡
        </button>
    </div>
    
    <!-- Progress -->
    <div id="sync-progress" class="hidden mb-4">
        <div class="flex items-center gap-2 mb-2">
            <div class="animate-spin text-xl">â³</div>
            <span id="sync-status">Ø¯Ø± Ø­Ø§Ù„ Sync...</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
            <div class="bg-primary h-2 rounded-full transition-all" id="progress-bar" style="width: 0%"></div>
        </div>
    </div>
    
    <!-- Ù†ØªÛŒØ¬Ù‡ -->
    <div id="sync-result" class="hidden">
        <div class="bg-green-50 border border-green-200 rounded-xl p-4">
            <h4 class="font-medium text-green-700 mb-2">âœ… Sync Ù…ÙˆÙÙ‚!</h4>
            <div id="sync-details"></div>
        </div>
    </div>
    
    {% endif %}
</div>

<!-- Database IDs -->
<div class="card mb-6">
    <h2 class="card-title mb-4">ğŸ—„ï¸ Database IDs</h2>
    
    <div class="space-y-3">
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
            <span class="text-gray-600">ğŸ“‹ Tasks</span>
            <code class="text-sm bg-white px-2 py-1 rounded border">{{ config.tasks_db or 'ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡' }}</code>
        </div>
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
            <span class="text-gray-600">ğŸ¯ Habits</span>
            <code class="text-sm bg-white px-2 py-1 rounded border">{{ config.habits_db or 'ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡' }}</code>
        </div>
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
            <span class="text-gray-600">ğŸ“Š Daily Log Sheet</span>
            <code class="text-sm bg-white px-2 py-1 rounded border">{{ config.daily_log_sheet or 'ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡' }}</code>
        </div>
    </div>
</div>

<!-- Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ… -->
<div class="card mb-6">
    <h2 class="card-title mb-4">ğŸ“– Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ…</h2>
    
    <div class="space-y-4">
        <!-- Notion -->
        <details class="group">
            <summary class="flex items-center gap-2 cursor-pointer p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                <span>ğŸ“</span>
                <span class="flex-1 font-medium">ØªÙ†Ø¸ÛŒÙ… Notion API</span>
                <svg class="w-5 h-5 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </summary>
            <div class="p-4 text-sm text-gray-600 space-y-2">
                <ol class="list-decimal list-inside space-y-1">
                    <li>Ø¨Ø±Ùˆ Ø¨Ù‡ <a href="https://www.notion.so/my-integrations" target="_blank" class="text-primary underline">notion.so/my-integrations</a></li>
                    <li>Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ <strong>New integration</strong></li>
                    <li>Ù†Ø§Ù…: ADHD Dashboard</li>
                    <li>Workspace Ø®ÙˆØ¯Øª Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†</li>
                    <li>ØªÙˆÚ©Ù† Ø±Ùˆ Ú©Ù¾ÛŒ Ú©Ù† Ùˆ Ø¯Ø± <code>.env</code> Ø¨Ø°Ø§Ø±</li>
                </ol>
            </div>
        </details>
        
        <!-- Google Sheets -->
        <details class="group">
            <summary class="flex items-center gap-2 cursor-pointer p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                <span>ğŸ“Š</span>
                <span class="flex-1 font-medium">ØªÙ†Ø¸ÛŒÙ… Google Sheets</span>
                <svg class="w-5 h-5 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </summary>
            <div class="p-4 text-sm text-gray-600 space-y-2">
                <ol class="list-decimal list-inside space-y-1">
                    <li>Ø¨Ø±Ùˆ Ø¨Ù‡ <a href="https://console.cloud.google.com" target="_blank" class="text-primary underline">Google Cloud Console</a></li>
                    <li>ÛŒÚ© Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯ Ø¨Ø³Ø§Ø²</li>
                    <li>Google Sheets API Ø±Ùˆ ÙØ¹Ø§Ù„ Ú©Ù†</li>
                    <li>Service Account Ø¨Ø³Ø§Ø² Ùˆ JSON Ú©Ù„ÛŒØ¯ Ø¨Ú¯ÛŒØ±</li>
                    <li>ÙØ§ÛŒÙ„ JSON Ø±Ùˆ Ú©Ù†Ø§Ø± Ù¾Ø±ÙˆÚ˜Ù‡ Ø¨Ø°Ø§Ø±</li>
                    <li>Sheet Ø±Ùˆ Ø¨Ø§ email Ø³Ø±ÙˆÛŒØ³ Ø§Ú©Ø§Ù†Øª Share Ú©Ù†</li>
                </ol>
            </div>
        </details>
        
        <!-- Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ Sheet -->
        <details class="group">
            <summary class="flex items-center gap-2 cursor-pointer p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                <span>ğŸ“‹</span>
                <span class="flex-1 font-medium">Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ Google Sheet (12 Ø³ØªÙˆÙ†)</span>
                <svg class="w-5 h-5 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </summary>
            <div class="p-4 text-sm text-gray-600">
                <table class="w-full text-xs">
                    <thead>
                        <tr class="border-b">
                            <th class="text-right py-1">Ø³ØªÙˆÙ†</th>
                            <th class="text-right py-1">Ù†Ø§Ù…</th>
                            <th class="text-right py-1">ØªÙˆØ¶ÛŒØ­</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>A</td><td>Date</td><td>ØªØ§Ø±ÛŒØ®</td></tr>
                        <tr><td>B</td><td>Mood</td><td>Ø­Ø§Ù„ (1-10)</td></tr>
                        <tr><td>C</td><td>Energy</td><td>Ø§Ù†Ø±Ú˜ÛŒ (1-10)</td></tr>
                        <tr><td>D</td><td>Top Win</td><td>Ø¨Ù‡ØªØ±ÛŒÙ† Ú©Ø§Ø±</td></tr>
                        <tr><td>E</td><td>Main Obstacle</td><td>Ù…Ø§Ù†Ø¹ Ø§ØµÙ„ÛŒ</td></tr>
                        <tr><td>F</td><td>Techniques Suggested</td><td>ØªÚ©Ù†ÛŒÚ© Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ</td></tr>
                        <tr><td>G</td><td>Reflection</td><td>Ø¨Ø§Ø²ØªØ§Ø¨</td></tr>
                        <tr class="bg-green-50"><td>H</td><td>Techniques Used</td><td>âœ¨ ØªÚ©Ù†ÛŒÚ© Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡</td></tr>
                        <tr class="bg-green-50"><td>I</td><td>Bad Habits</td><td>âœ¨ Ø¹Ø§Ø¯Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø¯</td></tr>
                        <tr class="bg-green-50"><td>J</td><td>Good Habits</td><td>âœ¨ Ø¹Ø§Ø¯Øªâ€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ¨</td></tr>
                        <tr class="bg-green-50"><td>K</td><td>Desires</td><td>âœ¨ Ø®ÙˆØ§Ø³ØªÙ‡â€ŒÙ‡Ø§</td></tr>
                        <tr class="bg-green-50"><td>L</td><td>Daily Report</td><td>âœ¨ Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²</td></tr>
                    </tbody>
                </table>
            </div>
        </details>
    </div>
</div>

<!-- Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ù…ÙÛŒØ¯ -->
<div class="card">
    <h2 class="card-title mb-4">ğŸ”— Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ù…ÙÛŒØ¯</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
        <a href="https://www.notion.so/my-integrations" target="_blank" 
           class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
            <span>ğŸ“</span>
            <span>Notion Integrations</span>
            <span class="mr-auto text-gray-400">â†—</span>
        </a>
        <a href="https://console.cloud.google.com" target="_blank"
           class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
            <span>â˜ï¸</span>
            <span>Google Cloud Console</span>
            <span class="mr-auto text-gray-400">â†—</span>
        </a>
        <a href="https://developers.notion.com" target="_blank"
           class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
            <span>ğŸ“š</span>
            <span>Notion API Docs</span>
            <span class="mr-auto text-gray-400">â†—</span>
        </a>
        <a href="https://docs.gspread.org" target="_blank"
           class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
            <span>ğŸ“Š</span>
            <span>gspread Docs</span>
            <span class="mr-auto text-gray-400">â†—</span>
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let uploadedFile = null;

// Drag & Drop
const dropZone = document.getElementById('drop-zone');
if (dropZone) {
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-primary', 'bg-blue-50');
    });
    
    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('border-primary', 'bg-blue-50');
    });
    
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-primary', 'bg-blue-50');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelect({ files: files });
        }
    });
}

// Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„
function handleFileSelect(input) {
    const file = input.files[0];
    if (file && (file.name.endsWith('.md') || file.name.endsWith('.txt'))) {
        uploadedFile = file;
        document.getElementById('file-name').textContent = file.name;
        document.getElementById('sync-file-btn').disabled = false;
        showToast('ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯', 'success');
    } else {
        showToast('ÙÙ‚Ø· ÙØ§ÛŒÙ„ MD ÛŒØ§ TXT', 'error');
    }
}

// Sync Ø¨Ø§ ÙØ§ÛŒÙ„
async function syncWithFile() {
    if (!uploadedFile) {
        showToast('ÙØ§ÛŒÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡', 'error');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', uploadedFile);
    
    await doSync(formData);
}

// Sync Ø¨Ø§ Ø³Ø§Ø®ØªØ§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶
async function syncWithDefault() {
    await doSync(null);
}

// Ø§Ù†Ø¬Ø§Ù… Sync
async function doSync(formData) {
    const progressDiv = document.getElementById('sync-progress');
    const resultDiv = document.getElementById('sync-result');
    const progressBar = document.getElementById('progress-bar');
    const statusText = document.getElementById('sync-status');
    
    progressDiv.classList.remove('hidden');
    resultDiv.classList.add('hidden');
    progressBar.style.width = '20%';
    statusText.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ...';
    
    try {
        progressBar.style.width = '50%';
        statusText.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Notion...';
        
        const options = {
            method: 'POST'
        };
        
        if (formData) {
            options.body = formData;
        } else {
            options.headers = { 'Content-Type': 'application/json' };
            options.body = JSON.stringify({});
        }
        
        const response = await fetch('/api/sync-notion', options);
        const result = await response.json();
        
        progressBar.style.width = '100%';
        
        if (result.success) {
            statusText.textContent = 'ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯!';
            
            let detailsHtml = '<ul class="list-disc list-inside text-sm space-y-1">';
            
            if (result.created.length > 0) {
                detailsHtml += `<li class="text-green-600">Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡: ${result.created.join(', ')}</li>`;
            }
            if (result.updated.length > 0) {
                detailsHtml += `<li class="text-blue-600">Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù‡: ${result.updated.join(', ')}</li>`;
            }
            if (result.errors.length > 0) {
                detailsHtml += `<li class="text-red-600">Ø®Ø·Ø§Ù‡Ø§: ${result.errors.join(', ')}</li>`;
            }
            
            detailsHtml += '</ul>';
            
            if (Object.keys(result.db_ids).length > 0) {
                detailsHtml += '<div class="mt-3 p-2 bg-white rounded border text-xs">';
                detailsHtml += '<strong>Database IDs (Ú©Ù¾ÛŒ Ú©Ù† Ø¯Ø± .env):</strong><br>';
                for (const [name, id] of Object.entries(result.db_ids)) {
                    detailsHtml += `NOTION_${name.toUpperCase()}_DB_ID=${id}<br>`;
                }
                detailsHtml += '</div>';
            }
            
            document.getElementById('sync-details').innerHTML = detailsHtml;
            resultDiv.classList.remove('hidden');
            
            showToast('Sync Ù…ÙˆÙÙ‚! ğŸ‰', 'success');
            
        } else {
            statusText.textContent = 'Ø®Ø·Ø§!';
            showToast(result.error || 'Ø®Ø·Ø§ Ø¯Ø± Sync', 'error');
        }
        
    } catch (error) {
        statusText.textContent = 'Ø®Ø·Ø§!';
        showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±', 'error');
        console.error(error);
    }
    
    setTimeout(() => {
        progressDiv.classList.add('hidden');
    }, 2000);
}
</script>
{% endblock %}
