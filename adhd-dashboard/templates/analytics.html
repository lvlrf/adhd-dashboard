{% extends "base.html" %}
{% block title %}ğŸ“Š Ø¢Ù…Ø§Ø±{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">ğŸ“Š Analytics</h1>
    <p class="text-gray-500">Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ Ùˆ ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§</p>
</div>

<!-- Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="card text-center">
        <div class="text-3xl font-bold text-purple-500">{{ summary.get('avg_mood', '-') }}</div>
        <div class="text-sm text-gray-500">ğŸ˜Š Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Mood</div>
    </div>
    <div class="card text-center">
        <div class="text-3xl font-bold text-blue-500">{{ summary.get('avg_energy', '-') }}</div>
        <div class="text-sm text-gray-500">âš¡ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Energy</div>
    </div>
    <div class="card text-center">
        <div class="text-3xl font-bold text-green-500">{{ task_stats.get('done', 0) }}</div>
        <div class="text-sm text-gray-500">âœ… Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</div>
    </div>
    <div class="card text-center">
        <div class="text-3xl font-bold text-orange-500">{{ summary.get('days_tracked', 0) }}</div>
        <div class="text-sm text-gray-500">ğŸ“… Ø±ÙˆØ²Ù‡Ø§ÛŒ Ø«Ø¨Øª Ø´Ø¯Ù‡</div>
    </div>
</div>

<!-- Ù†Ù…ÙˆØ¯Ø§Ø± Mood Ùˆ Energy -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <div class="card">
        <h2 class="card-title mb-4">ğŸ˜Š Ø±ÙˆÙ†Ø¯ Mood Ùˆ Energy</h2>
        {% if sheets_configured %}
        <div class="h-64">
            <canvas id="mood-chart"></canvas>
        </div>
        {% else %}
        <div class="h-64 flex items-center justify-center text-gray-400">
            Google Sheets ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡
        </div>
        {% endif %}
    </div>
    
    <div class="card">
        <h2 class="card-title mb-4">ğŸ“Š ØªÙˆØ²ÛŒØ¹ Ú©ÙˆØ§Ø¯Ø±Ø§Ù†Øªâ€ŒÙ‡Ø§</h2>
        {% if notion_configured %}
        <div class="h-64">
            <canvas id="quadrant-chart"></canvas>
        </div>
        {% else %}
        <div class="h-64 flex items-center justify-center text-gray-400">
            Notion ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡
        </div>
        {% endif %}
    </div>
</div>

<!-- Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Bad Habits Frequency -->
    <div class="card">
        <h2 class="card-title mb-4">ğŸ”´ ÙØ±Ø§ÙˆØ§Ù†ÛŒ Ø¹Ø§Ø¯Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø¯</h2>
        {% if sheets_configured %}
        <div class="h-64">
            <canvas id="bad-habits-chart"></canvas>
        </div>
        {% else %}
        <div class="h-64 flex items-center justify-center text-gray-400">
            Ù†ÛŒØ§Ø² Ø¨Ù‡ Google Sheets
        </div>
        {% endif %}
    </div>
    
    <!-- Good Habits Streak -->
    <div class="card">
        <h2 class="card-title mb-4">ğŸŸ¢ Ø±ÙˆÙ†Ø¯ Ø¹Ø§Ø¯Øªâ€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ¨</h2>
        {% if sheets_configured %}
        <div class="h-64">
            <canvas id="good-habits-chart"></canvas>
        </div>
        {% else %}
        <div class="h-64 flex items-center justify-center text-gray-400">
            Ù†ÛŒØ§Ø² Ø¨Ù‡ Google Sheets
        </div>
        {% endif %}
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Techniques Usage -->
    <div class="card">
        <h2 class="card-title mb-4">âš¡ ØªÚ©Ù†ÛŒÚ©â€ŒÙ‡Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡</h2>
        {% if sheets_configured %}
        <div class="h-64">
            <canvas id="techniques-chart"></canvas>
        </div>
        {% else %}
        <div class="h-64 flex items-center justify-center text-gray-400">
            Ù†ÛŒØ§Ø² Ø¨Ù‡ Google Sheets
        </div>
        {% endif %}
    </div>
    
    <!-- Energy Distribution -->
    <div class="card">
        <h2 class="card-title mb-4">ğŸ”‹ ØªÙˆØ²ÛŒØ¹ Ø§Ù†Ø±Ú˜ÛŒ Ú©Ø§Ø±Ù‡Ø§</h2>
        {% if notion_configured %}
        <div class="h-64">
            <canvas id="energy-chart"></canvas>
        </div>
        {% else %}
        <div class="h-64 flex items-center justify-center text-gray-400">
            Notion ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡
        </div>
        {% endif %}
    </div>
</div>

<!-- ÙØ±Ù… Ø«Ø¨Øª Daily Log -->
<div class="card">
    <h2 class="card-title mb-4">ğŸ“ Ø«Ø¨Øª Ù„Ø§Ú¯ Ø§Ù…Ø±ÙˆØ²</h2>
    
    {% if sheets_configured %}
    <form id="daily-log-form" onsubmit="submitDailyLog(event)">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
            <!-- Mood -->
            <div>
                <label class="label">ğŸ˜Š Mood (1-10)</label>
                <input type="range" id="log-mood" min="1" max="10" value="5" 
                       class="w-full" oninput="document.getElementById('mood-val').textContent = this.value">
                <div class="text-center text-sm text-gray-500">
                    <span id="mood-val">5</span> / 10
                </div>
            </div>
            
            <!-- Energy -->
            <div>
                <label class="label">âš¡ Energy (1-10)</label>
                <input type="range" id="log-energy" min="1" max="10" value="5"
                       class="w-full" oninput="document.getElementById('energy-val').textContent = this.value">
                <div class="text-center text-sm text-gray-500">
                    <span id="energy-val">5</span> / 10
                </div>
            </div>
            
            <!-- Top Win -->
            <div>
                <label class="label">ğŸ† Ø¨Ù‡ØªØ±ÛŒÙ† Ú©Ø§Ø± Ø§Ù…Ø±ÙˆØ²</label>
                <input type="text" id="log-topwin" class="input-field w-full" 
                       placeholder="Ú†Ù‡ Ú©Ø§Ø±ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø¯Ø§Ø¯ÛŒØŸ">
            </div>
            
            <!-- Techniques Used (Ø¬Ø¯ÛŒØ¯) -->
            <div>
                <label class="label">âš¡ ØªÚ©Ù†ÛŒÚ©â€ŒÙ‡Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡</label>
                <input type="text" id="log-techniques" class="input-field w-full"
                       placeholder="Pomodoro, Time Boxing, ...">
            </div>
            
            <!-- Bad Habits (Ø¬Ø¯ÛŒØ¯) -->
            <div>
                <label class="label">ğŸ”´ Ø¹Ø§Ø¯Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø¯ Ø§Ù…Ø±ÙˆØ²</label>
                <input type="text" id="log-badhabits" class="input-field w-full"
                       placeholder="Ø¨Ø§ Ú©Ø§Ù…Ø§ Ø¬Ø¯Ø§ Ú©Ù†">
            </div>
            
            <!-- Good Habits (Ø¬Ø¯ÛŒØ¯) -->
            <div>
                <label class="label">ğŸŸ¢ Ø¹Ø§Ø¯Øªâ€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ¨ Ø§Ù…Ø±ÙˆØ²</label>
                <input type="text" id="log-goodhabits" class="input-field w-full"
                       placeholder="Ø¨Ø§ Ú©Ø§Ù…Ø§ Ø¬Ø¯Ø§ Ú©Ù†">
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <!-- Main Obstacle -->
            <div>
                <label class="label">ğŸš§ Ù…Ø§Ù†Ø¹ Ø§ØµÙ„ÛŒ</label>
                <input type="text" id="log-obstacle" class="input-field w-full"
                       placeholder="Ú†ÛŒ Ø¬Ù„ÙˆØª Ø±Ùˆ Ú¯Ø±ÙØªØŸ">
            </div>
            
            <!-- Desires (Ø¬Ø¯ÛŒØ¯) -->
            <div>
                <label class="label">ğŸ’­ Ø®ÙˆØ§Ø³ØªÙ‡â€ŒÙ‡Ø§ Ùˆ Ø¢Ø±Ø²ÙˆÙ‡Ø§</label>
                <input type="text" id="log-desires" class="input-field w-full"
                       placeholder="Ø§Ù…Ø±ÙˆØ² Ú†ÛŒ Ù…ÛŒâ€ŒØ®ÙˆØ§Ø³ØªÛŒØŸ">
            </div>
        </div>
        
        <!-- Reflection -->
        <div class="mb-4">
            <label class="label">ğŸ’¡ Ø¨Ø§Ø²ØªØ§Ø¨ Ø±ÙˆØ²</label>
            <textarea id="log-reflection" class="input-field w-full" rows="2"
                      placeholder="Ú†ÛŒ ÛŒØ§Ø¯ Ú¯Ø±ÙØªÛŒØŸ"></textarea>
        </div>
        
        <!-- Daily Report (Ø¬Ø¯ÛŒØ¯) -->
        <div class="mb-4">
            <label class="label">ğŸ“ Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ù…Ù„ Ø±ÙˆØ²</label>
            <textarea id="log-report" class="input-field w-full" rows="3"
                      placeholder="Ø®Ù„Ø§ØµÙ‡â€ŒØ§ÛŒ Ø§Ø² Ú©Ù„ Ø±ÙˆØ²..."></textarea>
        </div>
        
        <button type="submit" class="btn-primary">
            ğŸ’¾ Ø«Ø¨Øª Ù„Ø§Ú¯
        </button>
    </form>
    {% else %}
    <div class="text-center py-8 text-gray-400">
        <p>Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ù„Ø§Ú¯ØŒ Google Sheets Ø±Ùˆ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†</p>
        <a href="{{ url_for('settings_page') }}" class="text-primary underline">Ø±ÙØªÙ† Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script>
// Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Ø³Ø±ÙˆØ±
const moodData = {{ mood_data|safe }};
const taskStats = {{ task_stats|tojson }};
const badHabitsFreq = {{ bad_habits_freq|safe }};
const goodHabitsStreak = {{ good_habits_streak|safe }};
const techniquesUsage = {{ techniques_usage|safe }};

// Ø±Ù†Ø¯Ø± Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§
document.addEventListener('DOMContentLoaded', function() {
    // Mood & Energy
    if (moodData && moodData.labels && moodData.labels.length > 0) {
        renderMoodChart('mood-chart', moodData);
    }
    
    // Quadrant
    if (taskStats && taskStats.by_quadrant) {
        renderQuadrantChart('quadrant-chart', taskStats.by_quadrant);
    }
    
    // Bad Habits
    if (badHabitsFreq && badHabitsFreq.length > 0) {
        renderBadHabitsChart('bad-habits-chart', badHabitsFreq);
    }
    
    // Good Habits
    if (goodHabitsStreak && goodHabitsStreak.length > 0) {
        renderGoodHabitsChart('good-habits-chart', goodHabitsStreak);
    }
    
    // Techniques
    if (techniquesUsage && techniquesUsage.length > 0) {
        renderTechniquesChart('techniques-chart', techniquesUsage);
    }
    
    // Energy
    if (taskStats && taskStats.by_energy) {
        renderEnergyChart('energy-chart', taskStats.by_energy);
    }
});

// Ø«Ø¨Øª Daily Log
async function submitDailyLog(event) {
    event.preventDefault();
    
    const data = {
        mood: parseInt(document.getElementById('log-mood').value),
        energy: parseInt(document.getElementById('log-energy').value),
        top_win: document.getElementById('log-topwin').value,
        main_obstacle: document.getElementById('log-obstacle').value,
        reflection: document.getElementById('log-reflection').value,
        techniques_used: document.getElementById('log-techniques').value,
        bad_habits: document.getElementById('log-badhabits').value,
        good_habits: document.getElementById('log-goodhabits').value,
        desires: document.getElementById('log-desires').value,
        daily_report: document.getElementById('log-report').value
    };
    
    try {
        const response = await fetch('/api/log-mood', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('Ù„Ø§Ú¯ Ø«Ø¨Øª Ø´Ø¯! ğŸ“', 'success');
            document.getElementById('daily-log-form').reset();
            document.getElementById('mood-val').textContent = '5';
            document.getElementById('energy-val').textContent = '5';
        } else {
            showToast(result.error || 'Ø®Ø·Ø§', 'error');
        }
    } catch (error) {
        showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø·', 'error');
    }
}
</script>
{% endblock %}
