{% extends "base.html" %}
{% block title %}ğŸ¯ Ø¹Ø§Ø¯Øªâ€ŒÙ‡Ø§{% endblock %}

{% block content %}
<!-- Ù‡Ø¯Ø± -->
<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
    <div>
        <h1 class="text-2xl font-bold text-gray-800">ğŸ¯ Habits Tracker</h1>
        <p class="text-gray-500">Ø±Ø¯ÛŒØ§Ø¨ÛŒ Ø¹Ø§Ø¯Øªâ€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ¨ Ùˆ Ø¨Ø¯</p>
    </div>
    
    <button onclick="openAddHabitModal()" class="btn-primary">
        â• Ø¹Ø§Ø¯Øª Ø¬Ø¯ÛŒØ¯
    </button>
</div>

{% if not habits_db_configured %}
<div class="bg-yellow-50 border border-yellow-200 text-yellow-700 px-4 py-3 rounded-xl mb-6">
    âš ï¸ Habits Database ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡. Ø§Ø¨ØªØ¯Ø§ Ø§Ø² SettingsØŒ Ø³Ø§Ø®ØªØ§Ø± Notion Ø±Ùˆ Sync Ú©Ù†.
    <a href="{{ url_for('settings_page') }}" class="underline">Ø±ÙØªÙ† Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</a>
</div>
{% endif %}

<!-- Ø¢Ù…Ø§Ø± -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="card text-center">
        <div class="text-3xl font-bold text-blue-500">{{ stats.get('active', 0) }}</div>
        <div class="text-sm text-gray-500">ğŸ¯ ÙØ¹Ø§Ù„</div>
    </div>
    <div class="card text-center">
        <div class="text-3xl font-bold text-purple-500">{{ stats.get('longest_streak', 0) }}</div>
        <div class="text-sm text-gray-500">ğŸ”¥ Ø¨Ù‡ØªØ±ÛŒÙ† Streak</div>
    </div>
    <div class="card text-center">
        <div class="text-3xl font-bold text-good">{{ stats.get('achieved', 0) }}</div>
        <div class="text-sm text-gray-500">ğŸ† Ù…ÙˆÙÙ‚ Ø´Ø¯Ù‡</div>
    </div>
    <div class="card text-center">
        <div class="text-3xl font-bold text-orange-500">{{ stats.get('total_counter', 0) }}</div>
        <div class="text-sm text-gray-500">ğŸ“Š Ú©Ù„ Ø§Ù†Ø¬Ø§Ù…</div>
    </div>
</div>

<!-- ÙÛŒÙ„ØªØ± -->
<div class="card mb-6">
    <div class="flex flex-wrap gap-2">
        <a href="{{ url_for('habits_page', filter='all') }}" 
           class="px-4 py-2 rounded-full text-sm font-medium transition
                  {% if filter_type == 'all' %}bg-primary text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
            Ù‡Ù…Ù‡
        </a>
        <a href="{{ url_for('habits_page', filter='good') }}"
           class="px-4 py-2 rounded-full text-sm font-medium transition
                  {% if filter_type == 'good' %}bg-good text-white{% else %}bg-green-100 text-green-700 hover:bg-green-200{% endif %}">
            ğŸŸ¢ Ø¹Ø§Ø¯Øªâ€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ¨
        </a>
        <a href="{{ url_for('habits_page', filter='bad') }}"
           class="px-4 py-2 rounded-full text-sm font-medium transition
                  {% if filter_type == 'bad' %}bg-bad text-white{% else %}bg-red-100 text-red-700 hover:bg-red-200{% endif %}">
            ğŸ”´ Ø¹Ø§Ø¯Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø¯
        </a>
        <a href="{{ url_for('habits_page', filter='active') }}"
           class="px-4 py-2 rounded-full text-sm font-medium transition
                  {% if filter_type == 'active' %}bg-blue-500 text-white{% else %}bg-blue-100 text-blue-700 hover:bg-blue-200{% endif %}">
            ğŸ¯ ÙØ¹Ø§Ù„
        </a>
    </div>
</div>

<!-- Ù„ÛŒØ³Øª Ø¹Ø§Ø¯Øªâ€ŒÙ‡Ø§ -->
<div class="space-y-4" id="habits-list">
    {% for habit in habits %}
    <div class="card hover:shadow-md transition-shadow habit-card" data-id="{{ habit.id }}">
        <div class="flex flex-col md:flex-row md:items-center gap-4">
            <!-- Ø¢ÛŒÚ©ÙˆÙ† Ù†ÙˆØ¹ -->
            <div class="flex items-center gap-3 md:w-1/3">
                <span class="text-2xl">
                    {% if habit.is_good %}ğŸŸ¢{% else %}ğŸ”´{% endif %}
                </span>
                <div>
                    <h3 class="font-medium text-gray-800">{{ habit.name }}</h3>
                    <div class="flex flex-wrap gap-1 mt-1">
                        {% if habit.category %}
                        <span class="text-xs px-2 py-0.5 bg-gray-100 text-gray-600 rounded-full">{{ habit.category }}</span>
                        {% endif %}
                        {% if habit.frequency %}
                        <span class="text-xs px-2 py-0.5 bg-blue-100 text-blue-600 rounded-full">{{ habit.frequency }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Ø¢Ù…Ø§Ø± -->
            <div class="flex items-center gap-6 md:w-1/3">
                <div class="text-center">
                    <div class="text-xl font-bold text-blue-500">{{ habit.counter }}</div>
                    <div class="text-xs text-gray-400">ğŸ”¢ Counter</div>
                </div>
                <div class="text-center">
                    <div class="text-xl font-bold text-orange-500">{{ habit.streak }}</div>
                    <div class="text-xs text-gray-400">ğŸ”¥ Streak</div>
                </div>
                <div class="text-center">
                    <div class="text-xl font-bold text-purple-500">{{ habit.best_streak }}</div>
                    <div class="text-xs text-gray-400">ğŸ† Best</div>
                </div>
            </div>
            
            <!-- Progress Ùˆ Ø§Ú©Ø´Ù†â€ŒÙ‡Ø§ -->
            <div class="flex items-center gap-3 md:w-1/3 justify-end">
                <!-- Progress Circle -->
                <div class="relative w-16 h-16">
                    <svg class="w-full h-full transform -rotate-90">
                        <circle cx="32" cy="32" r="28" stroke="#E5E7EB" stroke-width="4" fill="none"/>
                        <circle cx="32" cy="32" r="28" 
                                stroke="{% if habit.is_good %}#34A853{% else %}#EA4335{% endif %}" 
                                stroke-width="4" fill="none"
                                stroke-dasharray="176"
                                stroke-dashoffset="{{ 176 - (habit.streak * 176 / max(habit.best_streak, 30, 1)) }}"
                                stroke-linecap="round"/>
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span class="text-sm font-bold">{{ habit.streak }}</span>
                    </div>
                </div>
                
                <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ -->
                <div class="flex flex-col gap-1">
                    <button onclick="incrementHabit('{{ habit.id }}')" 
                            class="btn-primary text-sm px-3 py-1">
                        âœ“ Ø§Ù…Ø±ÙˆØ²
                    </button>
                    <button onclick="editHabit('{{ habit.id }}')" 
                            class="btn-secondary text-sm px-3 py-1">
                        âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Trigger (Ø§Ú¯Ù‡ Ø¯Ø§Ø±Ù‡) -->
        {% if habit.trigger %}
        <div class="mt-3 p-2 bg-yellow-50 rounded-lg text-sm text-yellow-700">
            âš¡ Trigger: {{ habit.trigger }}
        </div>
        {% endif %}
        
        <!-- Replacement (Ø¨Ø±Ø§ÛŒ Ø¹Ø§Ø¯Øª Ø¨Ø¯) -->
        {% if not habit.is_good and habit.replacement %}
        <div class="mt-2 p-2 bg-green-50 rounded-lg text-sm text-green-700">
            ğŸ”„ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†: {{ habit.replacement }}
        </div>
        {% endif %}
    </div>
    {% else %}
    <div class="card text-center py-12">
        <div class="text-5xl mb-4">ğŸ¯</div>
        <h3 class="text-lg font-medium text-gray-600">Ø¹Ø§Ø¯ØªÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯</h3>
        <p class="text-gray-400 mt-1">ÛŒÚ© Ø¹Ø§Ø¯Øª Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†</p>
    </div>
    {% endfor %}
</div>

<!-- Modal Ø§Ø¶Ø§ÙÙ‡/ÙˆÛŒØ±Ø§ÛŒØ´ Ø¹Ø§Ø¯Øª -->
<div id="habit-modal" class="modal hidden">
    <div class="modal-overlay" onclick="closeHabitModal()"></div>
    <div class="modal-content max-w-lg">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-bold" id="habit-modal-title">â• Ø¹Ø§Ø¯Øª Ø¬Ø¯ÛŒØ¯</h2>
            <button onclick="closeHabitModal()" class="btn-icon">âœ•</button>
        </div>
        
        <form id="habit-form" onsubmit="submitHabit(event)">
            <input type="hidden" id="habit-id" value="">
            
            <!-- Ù†Ø§Ù… -->
            <div class="mb-4">
                <label class="label">Ù†Ø§Ù… Ø¹Ø§Ø¯Øª *</label>
                <input type="text" id="habit-name" class="input-field w-full" 
                       placeholder="Ù…Ø«Ø§Ù„: ÙˆØ±Ø²Ø´ ØµØ¨Ø­Ú¯Ø§Ù‡ÛŒ" required>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                <!-- Ù†ÙˆØ¹ -->
                <div>
                    <label class="label">Ù†ÙˆØ¹</label>
                    <select id="habit-type" class="input-field w-full">
                        {% for opt in habit_type_options %}
                        <option value="{{ opt.name }}">{{ opt.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ -->
                <div>
                    <label class="label">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label>
                    <select id="habit-category" class="input-field w-full">
                        {% for opt in habit_category_options %}
                        <option value="{{ opt.name }}">{{ opt.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- ÙˆØ¶Ø¹ÛŒØª -->
                <div>
                    <label class="label">ÙˆØ¶Ø¹ÛŒØª</label>
                    <select id="habit-status" class="input-field w-full">
                        {% for opt in habit_status_options %}
                        <option value="{{ opt.name }}">{{ opt.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- ØªÚ©Ø±Ø§Ø± -->
                <div>
                    <label class="label">ØªÚ©Ø±Ø§Ø±</label>
                    <select id="habit-frequency" class="input-field w-full">
                        {% for opt in habit_frequency_options %}
                        <option value="{{ opt.name }}">{{ opt.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <!-- Trigger -->
            <div class="mb-4">
                <label class="label">Ù…Ø­Ø±Ú© (Trigger)</label>
                <input type="text" id="habit-trigger" class="input-field w-full"
                       placeholder="ÙˆÙ‚ØªÛŒ Ú©Ù‡... Ø§ÛŒÙ† Ø¹Ø§Ø¯Øª ÙØ¹Ø§Ù„ Ù…ÛŒØ´Ù‡">
            </div>
            
            <!-- Replacement (Ø¨Ø±Ø§ÛŒ Ø¹Ø§Ø¯Øª Ø¨Ø¯) -->
            <div class="mb-4" id="replacement-field">
                <label class="label">Ø¹Ø§Ø¯Øª Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† (Ø¨Ø±Ø§ÛŒ Ø¹Ø§Ø¯Øª Ø¨Ø¯)</label>
                <input type="text" id="habit-replacement" class="input-field w-full"
                       placeholder="Ø¨Ù‡ Ø¬Ø§ÛŒ Ø§ÛŒÙ† Ø¹Ø§Ø¯Øª Ø¨Ø¯ØŒ Ú†ÛŒÚ©Ø§Ø± Ú©Ù†Ù…ØŸ">
            </div>
            
            <!-- Ú†Ø±Ø§ Ù…Ù‡Ù…Ù‡ -->
            <div class="mb-4">
                <label class="label">Ú†Ø±Ø§ Ø§ÛŒÙ† Ø¹Ø§Ø¯Øª Ù…Ù‡Ù…Ù‡ØŸ</label>
                <textarea id="habit-why" class="input-field w-full" rows="2"
                          placeholder="Ø§Ù†Ú¯ÛŒØ²Ù‡â€ŒØ§Øª Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¹Ø§Ø¯Øª"></textarea>
            </div>
            
            <div class="flex justify-end gap-2">
                <button type="button" onclick="closeHabitModal()" class="btn-secondary">Ø§Ù†ØµØ±Ø§Ù</button>
                <button type="submit" class="btn-primary">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† modal Ø§Ø¶Ø§ÙÙ‡
function openAddHabitModal() {
    document.getElementById('habit-modal-title').textContent = 'â• Ø¹Ø§Ø¯Øª Ø¬Ø¯ÛŒØ¯';
    document.getElementById('habit-id').value = '';
    document.getElementById('habit-form').reset();
    document.getElementById('habit-modal').classList.remove('hidden');
}

// Ø¨Ø³ØªÙ† modal
function closeHabitModal() {
    document.getElementById('habit-modal').classList.add('hidden');
}

// ÙˆÛŒØ±Ø§ÛŒØ´ Ø¹Ø§Ø¯Øª
async function editHabit(habitId) {
    try {
        const response = await fetch('/api/habits');
        const data = await response.json();
        const habit = data.habits.find(h => h.id === habitId);
        
        if (habit) {
            document.getElementById('habit-modal-title').textContent = 'âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¹Ø§Ø¯Øª';
            document.getElementById('habit-id').value = habit.id;
            document.getElementById('habit-name').value = habit.name || '';
            document.getElementById('habit-type').value = habit.type || '';
            document.getElementById('habit-category').value = habit.category || '';
            document.getElementById('habit-status').value = habit.status || '';
            document.getElementById('habit-frequency').value = habit.frequency || '';
            document.getElementById('habit-trigger').value = habit.trigger || '';
            document.getElementById('habit-replacement').value = habit.replacement || '';
            document.getElementById('habit-why').value = habit.why || '';
            
            document.getElementById('habit-modal').classList.remove('hidden');
        }
    } catch (error) {
        showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ', 'error');
    }
}

// Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù…
async function submitHabit(event) {
    event.preventDefault();
    
    const habitId = document.getElementById('habit-id').value;
    const isEdit = !!habitId;
    
    const data = {
        name: document.getElementById('habit-name').value,
        type: document.getElementById('habit-type').value,
        category: document.getElementById('habit-category').value,
        status: document.getElementById('habit-status').value,
        frequency: document.getElementById('habit-frequency').value,
        trigger: document.getElementById('habit-trigger').value,
        replacement: document.getElementById('habit-replacement').value,
        why: document.getElementById('habit-why').value
    };
    
    try {
        const url = isEdit ? `/api/habits/${habitId}` : '/api/habits';
        const method = isEdit ? 'PATCH' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast(isEdit ? 'Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯' : 'Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯', 'success');
            closeHabitModal();
            setTimeout(() => location.reload(), 500);
        } else {
            showToast(result.error || 'Ø®Ø·Ø§', 'error');
        }
    } catch (error) {
        showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø·', 'error');
    }
}

// Ø§ÙØ²Ø§ÛŒØ´ Counter
async function incrementHabit(habitId) {
    try {
        const response = await fetch(`/api/habits/${habitId}/increment`, {
            method: 'POST'
        });
        const result = await response.json();
        
        if (result.success) {
            showToast(`Ø¢ÙØ±ÛŒÙ†! ğŸ‰ Streak: ${result.habit.streak}`, 'success');
            setTimeout(() => location.reload(), 500);
        } else {
            showToast(result.error || 'Ø®Ø·Ø§', 'error');
        }
    } catch (error) {
        showToast('Ø®Ø·Ø§', 'error');
    }
}

// Ù†Ù…Ø§ÛŒØ´/Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯ Replacement Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹
document.getElementById('habit-type')?.addEventListener('change', function() {
    const replacementField = document.getElementById('replacement-field');
    if (this.value.includes('Ø¨Ø¯') || this.value.includes('ğŸ”´')) {
        replacementField.style.display = 'block';
    } else {
        replacementField.style.display = 'none';
    }
});
</script>
{% endblock %}
